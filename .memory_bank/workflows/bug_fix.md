# Процесс исправления бага

## 1. Подготовка и анализ

### 1.1 Git Branch Setup
- [ ] Создать ветку от `develop` по шаблону `bugfix/TICKET-NUMBER-short-description`
  - Пример: `bugfix/DD-123-telegram-handler-crash`
  - Следовать конвенции из [../tech_stack.md](../tech_stack.md#version-control)

### 1.2 Task Tracking
- [ ] Обновить статус задачи в **[../current_tasks.md](../current_tasks.md)** на "In Progress"
- [ ] Добавить метку `[BUG]` к задаче для визуального выделения

### 1.3 Bug Analysis
- [ ] Изучить описание бага и воспроизвести проблему
- [ ] Собрать всю доступную информацию:
  - Логи ошибок с correlation_id для трейсинга
  - Шаги для воспроизведения
  - Ожидаемое vs. фактическое поведение
  - Информация об окружении (Python version, dependencies)
- [ ] Сгенерировать гипотезы о причинах бага:
  - Логические ошибки в коде
  - Проблемы с асинхронностью (race conditions, deadlocks)
  - Неправильная обработка edge cases
  - Проблемы с внешними API

### 1.4 Code Localization
- [ ] Локализовать проблему в кодовой базе
- [ ] Найти все релевантные файлы:
  - Основной модуль с багом
  - Зависимые модули
  - Тесты для затронутых модулей
- [ ] Проанализировать связанные документы:
  - **[../guides/](../guides/)** - для понимания подсистемы
  - **[../patterns/error_handling.md](../patterns/error_handling.md)** - если баг связан с обработкой ошибок
  - **[../patterns/api_standards.md](../patterns/api_standards.md)** - если баг в API integration

## 2. Разработка исправления

### 2.1 Write Fix
- [ ] Внести исправления в код, следуя **[стандартам кодирования](../guides/coding_standards.md)**:
  - Использовать type hints для всех функций
  - Добавить docstrings для новых/измененных функций
  - Обеспечить правильную обработку ошибок согласно **[../patterns/error_handling.md](../patterns/error_handling.md)**
  - Для async кода - проверить отсутствие blocking operations
- [ ] Добавить логирование с `correlation_id` для отладки
- [ ] Убедиться, что исправление решает root cause, а не симптом

### 2.2 Code Review Self-Check
- [ ] Проверить, что исправление:
  - Минимально - не меняет больше, чем нужно
  - Не создает новых багов в смежных областях
  - Не нарушает существующие API contracts
  - Следует архитектурным паттернам проекта

## 3. Тестирование

### 3.1 Add/Update Tests
- [ ] Написать тест, который воспроизводит баг (должен падать до исправления)
- [ ] Убедиться, что тест проходит после исправления
- [ ] Добавить edge case тесты для предотвращения регрессии
- [ ] Следовать **[стратегии тестирования](../guides/testing_strategy.md)**

### 3.2 Run Full Test Suite
- [ ] Запустить все тесты: `pytest`
- [ ] Для async кода: `pytest -v tests/ --asyncio-mode=auto`
- [ ] Убедиться, что:
  - Все тесты проходят
  - Нет новых warnings
  - Code coverage не снизился

### 3.3 Manual Testing
- [ ] Протестировать исправление вручную в development окружении
- [ ] Воспроизвести оригинальную проблему и убедиться, что она решена
- [ ] Проверить граничные случаи
- [ ] Для Telegram bot - протестировать в тестовом боте

## 4. Code Quality

### 4.1 Linting and Formatting
- [ ] Запустить Black: `poetry run black .`
- [ ] Запустить Ruff: `poetry run ruff check .`
- [ ] Запустить mypy: `poetry run mypy .`
- [ ] Исправить все найденные проблемы

### 4.2 Security Check
- [ ] Убедиться, что исправление не вводит:
  - SQL injection уязвимости
  - Утечки секретов в логи
  - Небезопасную десериализацию
  - Проблемы с async resource management

## 5. Документация

### 5.1 Code Documentation
- [ ] Обновить docstrings, если изменилось поведение функций
- [ ] Добавить комментарии для сложной логики исправления
- [ ] Объяснить WHY, а не WHAT в комментариях

### 5.2 Update Related Docs
- [ ] Обновить **[../guides/](../guides/)**, если баг выявил проблему в документации
- [ ] Обновить **[../patterns/](../patterns/)**, если нужно задокументировать новый паттерн
- [ ] Обновить **[../tech_stack.md](../tech_stack.md)**, если баг связан с версией библиотеки

## 6. Завершение

### 6.1 Task Status Update
- [ ] Обновить статус задачи в **[../current_tasks.md](../current_tasks.md)** на "Done"
- [ ] Добавить краткое описание решения в задачу

### 6.2 Commit and Push
- [ ] Создать коммит с осмысленным сообщением:
  ```
  fix(module): краткое описание исправления

  - Детали проблемы
  - Детали решения
  - Closes #TICKET-NUMBER
  ```
- [ ] Push ветки: `git push -u origin bugfix/TICKET-NUMBER-short-description`

### 6.3 Pull Request
- [ ] Создать Pull Request с описанием:
  - **Описание бага**: Что было не так?
  - **Root cause**: Почему это произошло?
  - **Решение**: Как исправлено?
  - **Тестирование**: Как проверить, что баг решен?
  - **Side effects**: Есть ли побочные эффекты?
- [ ] Добавить скриншоты/логи, если применимо
- [ ] Связать PR с ticket/issue

### 6.4 Self Review
- [ ] Провести self-review по чек-листу из **[code_review.md](./code_review.md)**
- [ ] Убедиться, что все критерии выполнены

## 7. Специфичные для проекта проверки

### Для Telegram Bot Handlers
- [ ] Протестировать обработку некорректного ввода пользователя
- [ ] Убедиться, что все user-facing сообщения на русском языке
- [ ] Проверить, что correlation_id передается во все вызовы для трейсинга
- [ ] Убедиться, что ошибки не показывают internal details пользователю

### Для External API Integration
- [ ] Добавить/обновить retry логику для transient errors
- [ ] Проверить timeout handling
- [ ] Убедиться, что используются Pydantic модели для валидации response
- [ ] Логировать все API calls с correlation_id

### Для Async Code
- [ ] Проверить отсутствие blocking I/O в async функциях
- [ ] Убедиться в правильном использовании async context managers
- [ ] Проверить proper cleanup of resources (using `async with`)
- [ ] Убедиться, что нет race conditions

### Для Database Operations
- [ ] Использовать parameterized queries (никаких строковых конкатенаций)
- [ ] Проверить, что транзакции правильно committed/rolled back
- [ ] Убедиться в правильной обработке connection pooling
- [ ] Добавить logging для всех DB operations

## Чек-лист готовности к merge
- [ ] Все тесты проходят
- [ ] Code coverage не снизился
- [ ] Все linters проходят без ошибок
- [ ] Документация обновлена
- [ ] Self-review выполнен
- [ ] Pull Request создан с полным описанием
- [ ] Нет TODO комментариев в коде (или они задокументированы в issues)
- [ ] Исправление решает root cause проблемы
- [ ] Добавлены тесты для предотвращения регрессии
